--- START OF FILE wallet.html ---


<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"> <!-- ALTERADO: user-scalable=yes para acessibilidade -->
    <title>Minha Carteira - Chivo</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        :root {
            --bg-color: #F4F7FC; --primary-blue: #0052FF; --secondary-blue: #007BFF;
            --accent-yellow: #FFC107; --text-dark: #121826; --text-light: #6C757D;
            --card-bg: #FFFFFF; --border-color: #DEE2E6; --success-color: #28a745; --error-color: #dc3545;
        }
        body { background-color: var(--bg-color); color: var(--text-dark); padding-bottom: 64px; }
        
        .main-container { padding: 1.2rem 0.8rem; }
        
        .header { display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 1.5rem; text-align: center; }
        .back-button { position: absolute; left: 0; font-size: 1.8rem; color: var(--text-dark); text-decoration: none; }
        .header h1 { font-size: 1.5rem; font-weight: 600; color: var(--text-dark); }

        .card { background-color: var(--card-bg); padding: 1.2rem; border-radius: 10px; box-shadow: 0 4px 20px rgba(0, 82, 255, 0.08); margin-bottom: 1.2rem; }
        .balances-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.2rem; }
        .balance-item { text-align: center; }
        .balance-item h3 { font-size: 0.7rem; color: var(--text-light); margin-bottom: 0.25rem; }
        .balance-item p { font-size: 1.5rem; font-weight: 600; color: var(--text-dark); }
        .balance-item p.bonus { color: var(--accent-yellow); }

        .wallet-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
        .action-btn { padding: 0.8rem; border-radius: 8px; border: none; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .deposit-btn { background-color: var(--success-color); color: #fff; }
        .withdraw-btn { background-color: var(--error-color); color: #fff; }
        
        .section-title { font-size: 1rem; font-weight: 600; margin: 1.5rem 0 0.8rem 0; }
        
        .wallet-summary-list { list-style: none; display: flex; flex-direction: column; gap: 0.8rem; }
        .summary-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .summary-item .label { color: var(--text-light); }
        .summary-item .value { font-weight: 600; }
        .summary-item .value.positive { color: var(--success-color); }
        .summary-item .value.negative { color: var(--error-color); }
        
        .transaction-list { display: flex; flex-direction: column; gap: 1.2rem; }
        .transaction-item { display: flex; justify-content: space-between; align-items: center; }
        .transaction-info h4 { font-size: 0.9rem; font-weight: 500; margin-bottom: 0.2rem; }
        .transaction-info p { font-size: 0.7rem; color: var(--text-light); }
        .transaction-right { text-align: right; }
        .transaction-amount { font-size: 1rem; font-weight: 600; }
        .transaction-amount.positive { color: var(--success-color); }
        .transaction-amount.negative { color: var(--error-color); }
        
        .view-history-btn { display: block; margin-top: 1.2rem; padding: 0.6rem; text-align: center; background-color: var(--bg-color); color: var(--primary-blue); text-decoration: none; border-radius: 8px; font-weight: 500; font-size: 0.9rem; transition: background-color 0.2s; }
        .view-history-btn:hover { background-color: #e9ecef; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.show { display: flex; }
        .modal-content { background-color: var(--card-bg); width: 90%; max-width: 400px; padding: 1.5rem; border-radius: 12px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.2rem; }
        .modal-header h2 { font-size: 1.1rem; }
        .modal-header .close-btn { font-size: 1.5rem; cursor: pointer; border: none; background: none; }
        .modal-body .input-group { position: relative; margin-bottom: 0.8rem; }
        .modal-body input, .modal-body textarea { width: 100%; padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem; }
        .modal-submit-btn { width: 100%; padding: 0.8rem; background-color: var(--primary-blue); border: none; border-radius: 8px; color: #fff; font-size: 1rem; cursor: pointer; display: flex; justify-content: center; align-items: center;}
        .modal-submit-btn:disabled { background-color: var(--text-light); cursor: not-allowed; }
        .hidden-step { display: none; }
        .method-selection-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; margin-bottom: 1.2rem; }
        .method-btn { padding: 0.8rem; border: 2px solid var(--border-color); border-radius: 8px; background-color: transparent; font-weight: 500; cursor: pointer; font-size: 0.9rem; text-align: center; }
        .method-btn.selected { border-color: var(--primary-blue); background-color: #e7f0ff; }
        .payment-info { background-color: #f8f9fa; padding: 1rem; border-radius: 8px; }
        .payment-info .timer { text-align: center; font-size: 1.2rem; font-weight: 600; color: var(--error-color); margin-bottom: 1rem; }
        .payment-info .info-line { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem; font-size: 0.9rem; }
        .info-line .label { color: var(--text-light); }
        .info-line .value { font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .info-line .copy-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-light); }
        .proof-options { display: flex; gap: 0.8rem; margin-bottom: 0.8rem; }
        .proof-btn { flex: 1; padding: 0.7rem; border: 2px solid var(--border-color); border-radius: 8px; background-color: transparent; cursor: pointer; font-size: 0.9rem;}
        .proof-btn.selected { border-color: var(--primary-blue); }
        .network-options { display: flex; gap: 0.8rem; margin-bottom: 0.8rem; }
        .network-btn { flex: 1; padding: 0.7rem; border: 2px solid var(--border-color); border-radius: 8px; background-color: transparent; font-weight: 500; cursor: pointer; font-size: 0.9rem;}
        .network-btn.selected { border-color: var(--primary-blue); background-color: #e7f0ff; }
        .fee-details { margin-top: 1rem; padding: 0.8rem; background-color: #f8f9fa; border-radius: 8px; font-size: 0.8rem; }
        .fee-details div { display: flex; justify-content: space-between; margin-bottom: 0.3rem; }
        .fee-details div:last-child { margin-bottom: 0; font-weight: 600; border-top: 1px solid var(--border-color); padding-top: 0.5rem; margin-top: 0.5rem; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--card-bg); box-shadow: 0 -2px 15px rgba(0,0,0,0.05); display: flex; justify-content: space-around; padding: 0.4rem 0; border-top-left-radius: 18px; border-top-right-radius: 18px; }
        .nav-link { display: flex; flex-direction: column; align-items: center; text-decoration: none; gap: 0.1rem; padding: 0.4rem; color: var(--text-light); flex-grow: 1; text-align: center; }
        .nav-link i { font-size: 1.3rem; }
        .nav-link span { font-size: 0.6rem; }
        .nav-link.active { color: var(--primary-blue); }
        /* NOVO: Estilos para a barra de feedback no topo */
        #feedback-bar-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 2000; /* Mais alto que o modal */
            display: flex;
            justify-content: center;
            align-items: center;
            padding-top: 20px;
            pointer-events: none;
        }
        .feedback-bar {
            background-color: var(--error-color); color: #fff; padding: 0.8rem 1.5rem;
            border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex; align-items: center; gap: 10px; font-size: 0.9rem;
            font-weight: 500; transform: translateY(-150%); opacity: 0;
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
            pointer-events: auto; max-width: 90%; text-align: center;
        }
        .feedback-bar.show { transform: translateY(0); opacity: 1; }
        .feedback-bar.success { background-color: var(--success-color); }
        .feedback-bar i { font-size: 1.3rem; }
        /* FIM: Estilos para a barra de feedback no topo */
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color:#fff; border-radius:50%; animation: spin 1s linear infinite; margin-left: 10px;}
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- NOVO: Container para a barra de feedback -->
    <div id="feedback-bar-container"></div>

    <div class="main-container">
        <header class="header"><a href="dashboard.html" class="back-button"><i class='bx bx-chevron-left'></i></a><h1>Minha Carteira</h1></header>
        <div class="card"><div class="balances-grid"><div class="balance-item"><h3>Carteira</h3><p id="wallet-balance">--</p></div><div class="balance-item"><h3>Bônus</h3><p id="bonus-balance" class="bonus">--</p></div></div></div>
        <div class="wallet-actions"><button class="action-btn deposit-btn" id="deposit-action-btn"><i class='bx bx-down-arrow-alt'></i> Depositar</button><button class="action-btn withdraw-btn" id="withdraw-action-btn"><i class='bx bx-up-arrow-alt'></i> Sacar</button></div>
        <h3 class="section-title">Resumo da Carteira</h3>
        <div class="card"><ul class="wallet-summary-list"><li class="summary-item"><span class="label">Total Depositado</span><strong class="value positive" id="total-deposited">--</strong></li><li class="summary-item"><span class="label">Total Sacado</span><strong class="value negative" id="total-withdrawn">--</strong></li><li class="summary-item"><span class="label">Lucro Total</span><strong class="value positive" id="total-profit">--</strong></li></ul></div>
        <h3 class="section-title">Atividade Recente</h3>
        <div class="card"><div id="transaction-list-container" class="transaction-list"><p>Carregando atividade...</p></div><a href="history.html" class="view-history-btn">Ver Histórico Completo</a></div>
    </div>

    <div id="deposit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Fazer um Depósito</h2><button class="close-btn">&times;</button></div>
            <div class="modal-body">
                <div id="deposit-step-1"><p style="margin-bottom:0.5rem; font-size: 0.9rem;">Insira o valor que deseja depositar.</p><p style="margin-bottom:1rem; font-size: 0.8rem; color: var(--text-light);">Mínimo: <span id="deposit-min-amount">--</span> MT / Máximo: <span id="deposit-max-amount">--</span> MT</p><form id="deposit-amount-form"><div class="input-group"><input type="number" id="deposit-amount-input" placeholder="Valor a depositar" required></div><button type="submit" class="modal-submit-btn" id="deposit-amount-submit-btn"><span>Avançar</span><div class="spinner" style="display: none;"></div></button></form></div>
                <div id="deposit-step-2" class="hidden-step"><p style="margin-bottom:1rem; font-size: 0.9rem;">Escolha a rede para o pagamento:</p><div id="deposit-method-selection" class="method-selection-grid"></div><div id="payment-info-container" style="display: none;"></div><form id="deposit-proof-form" style="display: none;"><hr style="margin: 1.2rem 0;"><p style="margin-bottom:1rem; font-size: 0.9rem;">Após pagar, envie o comprovativo.</p><div class="proof-options"><button type="button" class="proof-btn selected" data-proof-type="image">Imagem</button><button type="button" class="proof-btn" data-proof-type="text">Texto (SMS)</button></div><div id="proof-input-image" class="input-group"><input type="file" id="deposit-proof-file" accept="image/*"></div><div id="proof-input-text" class="input-group hidden-step"><textarea id="deposit-proof-text" rows="3" placeholder="Cole a mensagem de confirmação aqui"></textarea></div><button type="submit" class="modal-submit-btn" id="deposit-proof-submit-btn"><span>Enviar Comprovativo</span><div class="spinner" style="display: none;"></div></button></form></div>
            </div>
        </div>
    </div>
    
    <div id="withdraw-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Solicitar Saque</h2><button class="close-btn">&times;</button></div>
            <div class="modal-body">
                <form id="withdraw-form">
                    <div class="input-group"><input type="text" id="withdraw-name" placeholder="Nome do Titular" required></div>
                    <div class="input-group"><input type="tel" id="withdraw-number" placeholder="Número" required></div>
                    <p style="margin-bottom:0.5rem; font-size: 0.8rem; color: var(--text-light);">Mínimo: <span id="withdraw-min-amount">--</span> MT / Máximo: <span id="withdraw-max-amount">--</span> MT</p>
                    <div class="input-group"><input type="number" id="withdraw-amount" placeholder="Valor a sacar" required></div>
                    <div id="withdraw-fee-details" class="fee-details" style="display: none;"><div><span>Taxa de Saque (<span id="withdraw-fee-percent">0</span>%)</span><span id="withdraw-fee">--</span></div><div><span>Total a ser Deduzido</span><span id="withdraw-total">--</span></div></div>
                    <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 1rem; margin-bottom: 0.5rem;">Selecione a rede:</p>
                    <div class="network-options"><button type="button" class="network-btn" data-network="M-Pesa">M-Pesa</button><button type="button" class="network-btn" data-network="Emola">Emola</button></div>
                    <button type="submit" class="modal-submit-btn" id="withdraw-submit-btn"><span>Solicitar Saque</span><div class="spinner" style="display: none;"></div></button>
                </form>
            </div>
        </div>
    </div>

    <nav class="bottom-nav"><a href="dashboard.html" class="nav-link"><i class='bx bxs-home'></i><span>Início</span></a><a href="plans.html" class="nav-link"><i class='bx bxs-rocket'></i><span>Planos</span></a><a href="wallet.html" class="nav-link active"><i class='bx bxs-wallet'></i><span>Carteira</span></a><a href="profile.html" class="nav-link"><i class='bx bxs-user'></i><span>Perfil</span></a></nav>
    <!-- REMOVIDO: <div id="toast-container"></div> -->

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = "https://daksk.onrender.com";
            const TOKEN = localStorage.getItem('chivo-token');
            if (!TOKEN) { window.location.href = 'login.html'; return; }

            const elements = {
                walletBalance: document.getElementById('wallet-balance'), bonusBalance: document.getElementById('bonus-balance'), totalDeposited: document.getElementById('total-deposited'), totalWithdrawn: document.getElementById('total-withdrawn'), totalProfit: document.getElementById('total-profit'), transactionListContainer: document.getElementById('transaction-list-container'), depositModal: document.getElementById('deposit-modal'), withdrawModal: document.getElementById('withdraw-modal'), depositAmountForm: document.getElementById('deposit-amount-form'), depositProofForm: document.getElementById('deposit-proof-form'), withdrawForm: document.getElementById('withdraw-form'), depositStep1: document.getElementById('deposit-step-1'), depositStep2: document.getElementById('deposit-step-2'), depositMethodSelection: document.getElementById('deposit-method-selection'), paymentInfoContainer: document.getElementById('payment-info-container'), proofInputImage: document.getElementById('proof-input-image'), proofInputText: document.getElementById('proof-input-text'), depositProofFile: document.getElementById('deposit-proof-file'), depositProofText: document.getElementById('deposit-proof-text'), withdrawAmountInput: document.getElementById('withdraw-amount'), withdrawFeeDetails: document.getElementById('withdraw-fee-details'), withdrawFee: document.getElementById('withdraw-fee'), withdrawTotal: document.getElementById('withdraw-total'), withdrawFeePercent: document.getElementById('withdraw-fee-percent'),
                depositMinAmount: document.getElementById('deposit-min-amount'), depositMaxAmount: document.getElementById('deposit-max-amount'),
                withdrawMinAmount: document.getElementById('withdraw-min-amount'), withdrawMaxAmount: document.getElementById('withdraw-max-amount'),
                
                depositAmountSubmitBtn: document.getElementById('deposit-amount-submit-btn'),
                depositProofSubmitBtn: document.getElementById('deposit-proof-submit-btn'),
                withdrawSubmitBtn: document.getElementById('withdraw-submit-btn'),
                // CORREÇÃO AQUI: Capturar withdrawName e withdrawNumber
                withdrawNameInput: document.getElementById('withdraw-name'),
                withdrawNumberInput: document.getElementById('withdraw-number'),

                feedbackBarContainer: document.getElementById('feedback-bar-container')
            };

            // Obter os sub-elements dos botões APÓS o objeto elements ser definido
            const depositAmountSubmitBtnText = elements.depositAmountSubmitBtn.querySelector('span');
            const depositAmountSubmitBtnSpinner = elements.depositAmountSubmitBtn.querySelector('.spinner');
            const depositProofSubmitBtnText = elements.depositProofSubmitBtn.querySelector('span');
            const depositProofSubmitBtnSpinner = elements.depositProofSubmitBtn.querySelector('.spinner');
            const withdrawSubmitBtnText = elements.withdrawSubmitBtn.querySelector('span');
            const withdrawSubmitBtnSpinner = elements.withdrawSubmitBtn.querySelector('.spinner');


            let depositAmount = 0, paymentTimerInterval = null, selectedWithdrawNetwork = '', selectedProofType = 'image';
            let systemSettings = null; // Para armazenar as configurações da API

            const fetchAPI = async (endpoint, options = {}) => {
                options.headers = { ...options.headers, 'Authorization': `Bearer ${TOKEN}` };
                // Lógica corrigida para Content-Type:
                if (options.body && !(options.body instanceof FormData)) {
                    options.headers['Content-Type'] = 'application/json';
                } else if (options.body instanceof FormData) {
                    delete options.headers['Content-Type']; // Remover Content-Type se for FormData
                }
                
                const response = await fetch(`${API_URL}${endpoint}`, options);
                
                if (response.status === 401) { localStorage.removeItem('chivo-token'); window.location.href = 'login.html'; throw new Error('Sessão expirada. Por favor, faça login novamente.'); }
                const data = await response.json();
                if (!response.ok) { throw new Error(data.message || `Ocorreu um erro na API: ${response.statusText}`); }
                return data;
            };

            const formatCurrency = (value = 0) => new Intl.NumberFormat('pt-MZ', { style: 'currency', currency: 'MZN' }).format(value);

            // Função para exibir a barra de feedback (idêntica às outras)
            function showFeedbackBar(message, type = 'error') {
                elements.feedbackBarContainer.innerHTML = ''; 
                let iconClass = type === 'success' ? 'bx bx-check-circle' : 'bx bx-x-circle';

                const feedbackBar = document.createElement('div');
                feedbackBar.className = `feedback-bar ${type}`;
                feedbackBar.innerHTML = `<i class='${iconClass}'></i> <span></span>`;
                feedbackBar.querySelector('span').textContent = message; // Proteção contra XSS
                elements.feedbackBarContainer.appendChild(feedbackBar);

                setTimeout(() => { feedbackBar.classList.add('show'); }, 50); 
                setTimeout(() => {
                    feedbackBar.classList.remove('show');
                    feedbackBar.addEventListener('transitionend', () => feedbackBar.remove(), { once: true });
                }, 4000);
            }

            const loadWalletData = async () => {
                try {
                    // CORREÇÃO: Carregar as configurações *primeiro* e *separadamente*
                    const settingsResponse = await fetchAPI('/api/settings/public');
                    systemSettings = settingsResponse; 
                    updateModalLimits(); // Atualiza os limites imediatamente

                    // Depois, carregar o resto em paralelo
                    const [user, summary, transactions] = await Promise.all([ 
                        fetchAPI('/api/users/me'), 
                        fetchAPI('/api/users/wallet-summary'), 
                        fetchAPI('/api/users/transactions')
                    ]);
                    
                    elements.walletBalance.textContent = formatCurrency(user.walletBalance); 
                    elements.bonusBalance.textContent = formatCurrency(user.bonusBalance); 
                    renderWalletSummary(summary); 
                    renderRecentTransactions(transactions);
                } catch (error) { 
                    showFeedbackBar(error.message, 'error'); 
                    elements.transactionListContainer.innerHTML = `<p style="text-align: center; color: var(--text-light);">Não foi possível carregar os dados: ${error.message}</p>`; 
                }
            };
            
            const updateModalLimits = () => {
                if (systemSettings) {
                    elements.depositMinAmount.textContent = systemSettings.depositMin ?? '0'; 
                    elements.depositMaxAmount.textContent = systemSettings.depositMax ?? '0';
                    elements.withdrawMinAmount.textContent = systemSettings.withdrawalMin ?? '0';
                    elements.withdrawMaxAmount.textContent = systemSettings.withdrawalMax ?? '0';
                    elements.withdrawFeePercent.textContent = systemSettings.withdrawalFee ?? '0';
                } else {
                    elements.depositMinAmount.textContent = 'N/A';
                    elements.depositMaxAmount.textContent = 'N/A';
                    elements.withdrawMinAmount.textContent = 'N/A';
                    elements.withdrawMaxAmount.textContent = 'N/A';
                    elements.withdrawFeePercent.textContent = '0';
                }
            };

            const renderWalletSummary = (summary) => {
                elements.totalDeposited.textContent = `+ ${formatCurrency(summary.totalDeposited)}`; 
                elements.totalWithdrawn.textContent = `- ${formatCurrency(summary.totalWithdrawn)}`; 
                elements.totalProfit.textContent = `+ ${formatCurrency(summary.totalProfit)}`;
            };

            const renderRecentTransactions = (transactions) => {
                const container = elements.transactionListContainer; 
                if (!transactions || transactions.length === 0) { 
                    container.innerHTML = '<p style="text-align: center; color: var(--text-light);">Nenhuma atividade recente.</p>'; 
                    return; 
                }
                const recentTransactions = transactions.slice(0, 3);
                container.innerHTML = recentTransactions.map(t => {
                    const isPositive = ['deposit', 'collection', 'commission', 'welcome_bonus', 'lottery_win'].includes(t.type) && t.status !== 'rejected';
                    const amountClass = isPositive ? 'positive' : 'negative'; 
                    const prefix = isPositive && t.amount > 0 ? '+' : '-';
                    const displayAmount = (t.type === 'withdrawal' || t.type === 'investment') ? Math.abs(t.amount) : t.amount;

                    return `<div class="transaction-item"><div class="transaction-info"><h4>${t.description}</h4><p>${new Date(t.createdAt).toLocaleDateString('pt-BR')}</p></div><div class="transaction-right"><span class="transaction-amount ${amountClass}">${prefix}${formatCurrency(displayAmount)}</span></div></div>`;
                }).join('');
            };

            const calculateWithdrawalFee = () => {
                const amount = parseFloat(elements.withdrawAmountInput.value); 
                // CORREÇÃO: Garante que systemSettings e withdrawalFee existem antes de calcular
                if (isNaN(amount) || amount <= 0 || !systemSettings || systemSettings.withdrawalFee === undefined) {
                    elements.withdrawFee.textContent = formatCurrency(0); 
                    elements.withdrawTotal.textContent = formatCurrency(0); 
                    elements.withdrawFeeDetails.style.display = 'none'; // Esconde se não houver valor válido
                    return; 
                }
                elements.withdrawFeeDetails.style.display = 'block'; // Mostra quando há cálculo
                const fee = (amount * systemSettings.withdrawalFee) / 100;
                const total = amount + fee; 
                elements.withdrawFee.textContent = formatCurrency(fee); 
                elements.withdrawTotal.textContent = formatCurrency(total); 
            };
            
            const setupEventListeners = () => {
                document.getElementById('deposit-action-btn').addEventListener('click', () => openModal(elements.depositModal)); 
                document.getElementById('withdraw-action-btn').addEventListener('click', () => openModal(elements.withdrawModal)); 
                elements.depositModal.querySelector('.close-btn').addEventListener('click', () => closeModal(elements.depositModal)); 
                elements.withdrawModal.querySelector('.close-btn').addEventListener('click', () => closeModal(elements.withdrawModal)); 
                elements.depositAmountForm.addEventListener('submit', handleDepositAmountSubmit); 
                elements.depositProofForm.addEventListener('submit', handleDepositProofSubmit); 
                elements.withdrawForm.addEventListener('submit', handleWithdrawSubmit); 
                elements.withdrawAmountInput.addEventListener('input', calculateWithdrawalFee);
                
                document.getElementById('deposit-proof-form').addEventListener('click', (e) => {
                    if (e.target.matches('.proof-btn')) {
                        document.querySelector('.proof-btn.selected')?.classList.remove('selected');
                        e.target.classList.add('selected'); selectedProofType = e.target.dataset.proofType;
                        if (selectedProofType === 'image') { elements.proofInputImage.classList.remove('hidden-step'); elements.proofInputText.classList.add('hidden-step');
                        } else { elements.proofInputImage.classList.add('hidden-step'); elements.proofInputText.classList.remove('hidden-step'); }
                    }
                });

                document.getElementById('withdraw-form').addEventListener('click', (e) => {
                    if (e.target.matches('.network-btn')) { if (document.querySelector('.network-btn.selected')) { document.querySelector('.network-btn.selected').classList.remove('selected'); }
                        e.target.classList.add('selected'); selectedWithdrawNetwork = e.target.dataset.network;
                    }
                });

                document.getElementById('deposit-modal').addEventListener('click', (e) => {
                     const copyBtn = e.target.closest('.copy-btn'); if (copyBtn) { navigator.clipboard.writeText(copyBtn.dataset.copy).then(() => showFeedbackBar('Número copiado para a área de transferência!', 'success')).catch(() => showFeedbackBar('Falha ao copiar o número.', 'error')); }
                });

                // Fechar modais ao clicar fora
                elements.depositModal.addEventListener('click', (e) => {
                    if (e.target === elements.depositModal) closeModal(elements.depositModal);
                });
                elements.withdrawModal.addEventListener('click', (e) => {
                    if (e.target === elements.withdrawModal) closeModal(elements.withdrawModal);
                });
            };

            const openModal = (modal) => {
                modal.classList.add('show'); 
                if (modal.id === 'withdraw-modal') { 
                    elements.withdrawAmountInput.value = ''; 
                    const selectedBtn = document.querySelector('#withdraw-form .network-btn.selected'); 
                    if (selectedBtn) selectedBtn.classList.remove('selected'); 
                    selectedWithdrawNetwork = ''; 
                    // Garante que o input de nome e número esteja limpo ao abrir
                    elements.withdrawNameInput.value = ''; // CORREÇÃO
                    elements.withdrawNumberInput.value = ''; // CORREÇÃO
                    calculateWithdrawalFee(); // Chamada inicial para exibir taxas ao abrir o modal
                } else if (modal.id === 'deposit-modal') {
                    elements.depositStep1.style.display = 'block';
                    elements.depositStep2.style.display = 'none';
                    elements.paymentInfoContainer.style.display = 'none';
                    elements.depositProofForm.style.display = 'none';
                    elements.depositMethodSelection.innerHTML = '';
                    document.getElementById('deposit-amount-input').value = '';
                }
                updateModalLimits(); // Garante que os limites são atualizados ao abrir
            };
            
            const closeModal = (modal) => {
                modal.classList.remove('show'); 
                if (paymentTimerInterval) { clearInterval(paymentTimerInterval); paymentTimerInterval = null; }
                elements.depositStep1.style.display = 'block'; 
                elements.depositStep2.style.display = 'none'; 
                elements.paymentInfoContainer.style.display = 'none'; 
                elements.depositProofForm.style.display = 'none'; 
                elements.depositMethodSelection.innerHTML = '';
            };

            const handleDepositAmountSubmit = async (e) => {
                e.preventDefault(); 
                depositAmount = parseFloat(document.getElementById('deposit-amount-input').value); 
                
                const submitButton = elements.depositAmountSubmitBtn;
                submitButton.disabled = true;
                depositAmountSubmitBtnText.textContent = 'Avançando...';
                depositAmountSubmitBtnSpinner.style.display = 'inline-block';


                if (isNaN(depositAmount) || depositAmount <= 0) { 
                    showFeedbackBar("Por favor, insira um valor de depósito válido e maior que zero.", 'error'); 
                    submitButton.disabled = false;
                    depositAmountSubmitBtnText.textContent = 'Avançar';
                    depositAmountSubmitBtnSpinner.style.display = 'none';
                    return; 
                }
                if (!systemSettings || depositAmount < systemSettings.depositMin || depositAmount > systemSettings.depositMax) {
                    showFeedbackBar(`O valor do depósito deve estar entre ${systemSettings?.depositMin || '0'} MT e ${systemSettings?.depositMax || '0'} MT.`, 'error'); 
                    submitButton.disabled = false;
                    depositAmountSubmitBtnText.textContent = 'Avançar';
                    depositAmountSubmitBtnSpinner.style.display = 'none';
                    return; 
                }
                try {
                    const activeMethods = systemSettings.depositMethods.filter(m => m.isActive); 
                    elements.depositMethodSelection.innerHTML = '';
                    if (activeMethods.length === 0) { 
                        showFeedbackBar('Nenhum método de depósito ativo configurado. Por favor, tente novamente mais tarde.', 'error'); // Feedback direto
                        submitButton.disabled = false;
                        depositAmountSubmitBtnText.textContent = 'Avançar';
                        depositAmountSubmitBtnSpinner.style.display = 'none';
                        return; // Sai da função
                    } else { 
                        activeMethods.forEach(method => { 
                            const btn = document.createElement('button'); 
                            btn.type = 'button'; btn.className = 'method-btn'; 
                            btn.textContent = method.name; 
                            btn.dataset.method = JSON.stringify(method); 
                            btn.addEventListener('click', handleMethodSelection); 
                            elements.depositMethodSelection.appendChild(btn); 
                        }); 
                    }
                    elements.depositStep1.style.display = 'none'; 
                    elements.depositStep2.style.display = 'block';
                } catch (error) { 
                    showFeedbackBar('Erro ao carregar métodos de pagamento: ' + error.message, 'error'); 
                } finally {
                    submitButton.disabled = false;
                    depositAmountSubmitBtnText.textContent = 'Avançar';
                    depositAmountSubmitBtnSpinner.style.display = 'none';
                }
            };

            function handleMethodSelection(event) {
                const allBtns = elements.depositMethodSelection.querySelectorAll('.method-btn'); 
                allBtns.forEach(b => b.classList.remove('selected')); 
                const selectedBtn = event.currentTarget; 
                selectedBtn.classList.add('selected'); 
                const method = JSON.parse(selectedBtn.dataset.method); 
                renderPaymentScreen(method.number, method.holderName, method.name); 
                elements.paymentInfoContainer.style.display = 'block'; 
                elements.depositProofForm.style.display = 'block';
            }

            function renderPaymentScreen(number, holderName, networkName) {
                let timeLeft = 600; // 10 minutos
                if (paymentTimerInterval) clearInterval(paymentTimerInterval);
                const updateTimer = () => { 
                    if (timeLeft <= 0) { clearInterval(paymentTimerInterval); elements.paymentInfoContainer.querySelector('.timer').textContent = 'Tempo Esgotado'; return; } 
                    timeLeft--; 
                    const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0'); 
                    const seconds = (timeLeft % 60).toString().padStart(2, '0'); 
                    elements.paymentInfoContainer.querySelector('.timer').textContent = `${minutes}:${seconds}`; 
                };
                elements.paymentInfoContainer.innerHTML = `<div class="timer">${Math.floor(timeLeft/60).toString().padStart(2,'0')}:${(timeLeft%60).toString().padStart(2,'0')}</div><div class="info-line"><span class="label">Rede:</span> <strong class="value">${networkName}</strong></div><div class="info-line"><span class="label">Titular:</span> <strong class="value">${holderName}</strong></div><div class="info-line"><span class="label">Número:</span> <strong class="value">${number} <button class="copy-btn" data-copy="${number}"><i class='bx bx-copy'></i></button></strong></div>`;
                paymentTimerInterval = setInterval(updateTimer, 1000);
            }

            const handleDepositProofSubmit = async (e) => {
                e.preventDefault(); 
                const submitButton = elements.depositProofSubmitBtn;
                submitButton.disabled = true;
                depositProofSubmitBtnText.textContent = 'Enviando...';
                depositProofSubmitBtnSpinner.style.display = 'inline-block';

                try {
                    const formData = new FormData(); 
                    formData.append('amount', depositAmount);
                    if (selectedProofType === 'image') { 
                        const proofFile = elements.depositProofFile.files[0]; 
                        if (!proofFile) throw new Error('Por favor, selecione um arquivo de imagem para o comprovativo.'); 
                        formData.append('proof', proofFile); 
                    } else { 
                        const proofText = elements.depositProofText.value.trim(); 
                        if (!proofText) throw new Error('Por favor, cole o texto da mensagem de confirmação.'); 
                        formData.append('proofText', proofText); 
                    }
                    const result = await fetchAPI('/api/users/deposit', { method: 'POST', body: formData }); 
                    showFeedbackBar(result.message, 'success'); 
                    closeModal(elements.depositModal); 
                    loadWalletData();
                } catch (error) { 
                    showFeedbackBar(error.message, 'error'); 
                } finally { 
                    submitButton.disabled = false; 
                    depositProofSubmitBtnText.textContent = 'Enviar Comprovativo';
                    depositProofSubmitBtnSpinner.style.display = 'none';
                }
            };

            const handleWithdrawSubmit = async (e) => {
                e.preventDefault();
                const submitButton = elements.withdrawSubmitBtn;
                submitButton.disabled = true;
                withdrawSubmitBtnText.textContent = 'Solicitando...';
                withdrawSubmitBtnSpinner.style.display = 'inline-block';

                if (!selectedWithdrawNetwork) { 
                    showFeedbackBar('Por favor, selecione uma rede de pagamento para o saque.', 'error'); 
                    submitButton.disabled = false;
                    withdrawSubmitBtnText.textContent = 'Solicitar Saque';
                    withdrawSubmitBtnSpinner.style.display = 'none';
                    return; 
                }
                const amount = parseFloat(elements.withdrawAmountInput.value); 
                const paymentNumber = elements.withdrawNumberInput.value.trim(); // CORREÇÃO
                const holderName = elements.withdrawNameInput.value.trim(); // CORREÇÃO

                if (isNaN(amount) || amount <= 0) {
                    showFeedbackBar('Por favor, insira um valor de saque válido e positivo.', 'error');
                    submitButton.disabled = false;
                    withdrawSubmitBtnText.textContent = 'Solicitar Saque';
                    withdrawSubmitBtnSpinner.style.display = 'none';
                    return;
                }
                if (!paymentNumber || !holderName) {
                    showFeedbackBar('Por favor, preencha o nome do titular e o número para pagamento.', 'error');
                    submitButton.disabled = false;
                    withdrawSubmitBtnText.textContent = 'Solicitar Saque';
                    withdrawSubmitBtnSpinner.style.display = 'none';
                    return;
                }
                if (!systemSettings || amount < systemSettings.withdrawalMin || amount > systemSettings.withdrawalMax) {
                    showFeedbackBar(`O valor do saque deve estar entre ${systemSettings?.withdrawalMin || '0'} MT e ${systemSettings?.withdrawalMax || '0'} MT.`, 'error'); 
                    submitButton.disabled = false;
                    withdrawSubmitBtnText.textContent = 'Solicitar Saque';
                    withdrawSubmitBtnSpinner.style.display = 'none';
                    return; 
                }


                const body = { 
                    amount: amount, 
                    paymentNumber: paymentNumber,
                    holderName: holderName,
                    network: selectedWithdrawNetwork 
                };

                try {
                    const result = await fetchAPI('/api/users/withdraw', { method: 'POST', body: JSON.stringify(body) });
                    showFeedbackBar(result.message, 'success');
                    closeModal(elements.withdrawModal);
                    elements.withdrawForm.reset();
                    loadWalletData();
                } catch (error) { 
                    showFeedbackBar(error.message, 'error'); 
                } finally {
                    submitButton.disabled = false;
                    withdrawSubmitBtnText.textContent = 'Solicitar Saque';
                    withdrawSubmitBtnSpinner.style.display = 'none';
                }
            };

            loadWalletData(); // Chame esta função na inicialização
            setupEventListeners();
        });
    </script>
</body>
</html>